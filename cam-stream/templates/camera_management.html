<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>摄像头管理 - Cam-Stream</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background-color: #f5f6fa;
        color: #2c3e50;
        padding: 30px;
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
      }

      .header h1 {
        font-size: 32px;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 10px;
      }

      .header p {
        color: #7f8c8d;
        font-size: 18px;
      }

      /* 卡片样式 */
      .card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        padding: 25px;
        margin-bottom: 20px;
        border: 1px solid #e1e8ed;
      }

      .card h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #2c3e50;
      }

      /* 按钮样式 */
      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-block;
      }

      .btn-primary {
        background: #3498db;
        color: white;
      }

      .btn-primary:hover {
        background: #2980b9;
      }

      .btn-danger {
        background: #e74c3c;
        color: white;
      }

      .btn-danger:hover {
        background: #c0392b;
      }

      /* 表单样式 */
      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #2c3e50;
      }

      .form-control {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.2s;
      }

      .form-control:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
      }

      /* 表格样式 */
      .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      .table th,
      .table td {
        padding: 15px 12px;
        text-align: left;
        border-bottom: 1px solid #e1e8ed;
      }

      .table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
      }

      .table tbody tr:hover {
        background: #f8f9fa;
      }

      /* 状态指示器 */
      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-running {
        background: #27ae60;
        box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.3);
      }

      .status-stopped {
        background: #95a5a6;
      }

      /* 摄像头网格布局 */
      .cameras-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        padding: 20px 0;
      }

      .camera-card {
        background: white;
        border: 1px solid #e1e8ed;
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: box-shadow 0.2s;
        display: flex;
        flex-direction: column;
        min-height: 280px;
      }

      .camera-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      }

      .camera-header {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }

      .camera-name {
        font-weight: 600;
        font-size: 16px;
        color: #2c3e50;
        margin-right: 12px;
        flex: 1;
      }

      .camera-status {
        display: flex;
        align-items: center;
        font-size: 12px;
        color: #666;
      }

      .camera-rtsp {
        font-size: 11px;
        color: #666;
        background: #f8f9fa;
        padding: 4px 8px;
        border-radius: 4px;
        margin-bottom: 12px;
        word-break: break-all;
      }

      .camera-servers {
        margin-bottom: 12px;
        min-height: 40px;
      }

      .camera-actions {
        display: flex;
        gap: 8px;
        margin-top: auto;
      }

      .camera-actions .btn {
        flex: 1;
        padding: 8px 12px;
        font-size: 12px;
      }

      /* 推理服务器网格布局 */
      .inference-servers-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      /* 在添加摄像头表单中，推理服务器列表使用五列布局 */
      #inferenceServersList.inference-servers-grid {
        grid-template-columns: repeat(5, 1fr);
      }

      .server-item {
        padding: 12px;
        border: 1px solid #eee;
        border-radius: 6px;
        background: #fafafa;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .server-item:hover {
        border-color: #3498db;
        background: #f8f9fa;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(52, 152, 219, 0.15);
      }

      .server-header {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
      }

      .server-checkbox {
        margin-right: 8px;
      }

      .server-info {
        flex: 1;
      }

      .server-name {
        font-weight: 500;
        margin-right: 8px;
      }

      .server-type {
        background: #e8f4fd;
        color: #1e88e5;
        padding: 2px 6px;
        border-radius: 8px;
        font-size: 10px;
      }

      /* Checkbox和Range Input指针样式 */
      input[type="checkbox"], input[type="range"] {
        cursor: pointer;
      }

      /* 双端滑块样式 */
      .range-slider {
        position: relative;
        height: 6px;
        background: #ddd;
        border-radius: 3px;
        margin: 15px 0;
      }

      .range-slider .track {
        position: absolute;
        height: 100%;
        background: #3498db;
        border-radius: 3px;
      }

      .range-slider input[type="range"] {
        position: absolute;
        width: 100%;
        height: 6px;
        background: transparent;
        appearance: none;
        pointer-events: none;
        cursor: pointer;
      }

      .range-slider input[type="range"]::-webkit-slider-thumb {
        appearance: none;
        width: 18px;
        height: 18px;
        background: #3498db;
        border-radius: 50%;
        pointer-events: all;
        cursor: pointer;
        border: 2px solid white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      }

      .range-slider input[type="range"]::-moz-range-thumb {
        width: 18px;
        height: 18px;
        background: #3498db;
        border-radius: 50%;
        pointer-events: all;
        cursor: pointer;
        border: 2px solid white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      }

      /* 推理服务器卡片删除按钮样式 */
      .server-delete-btn {
        position: absolute;
        bottom: 12px;
        right: 16px;
        width: auto;
        height: 20px;
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 10px;
        font-weight: 500;
        line-height: 1;
        padding: 0 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
      }

      .server-delete-btn:hover {
        background: #c0392b;
      }

      .range-values {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: #666;
        margin-top: 8px;
      }

      /* 大型Modal样式 */
      .large-modal {
        width: 90%;
        max-width: 1800px;
        max-height: 95vh;
        min-width: 1400px;
      }
      
      /* 编辑对话框中的推理服务器网格布局 */
      #editInferenceServersList.inference-servers-grid {
        grid-template-columns: repeat(5, 1fr) !important;
      }

      /* 响应式设计 */
      @media (max-width: 1200px) {
        .cameras-grid {
          grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }
      }

      @media (max-width: 768px) {
        body {
          padding: 15px;
        }
        
        .cameras-grid {
          grid-template-columns: 1fr;
          gap: 15px;
        }
        
        .inference-servers-grid {
          grid-template-columns: 1fr;
        }
        
        .large-modal {
          width: 98%;
          max-height: 95vh;
        }

        .table {
          font-size: 12px;
        }

        .table th,
        .table td {
          padding: 10px 8px;
        }

        .btn {
          padding: 8px 16px;
          font-size: 12px;
        }
      }

      /* 加载状态 */
      .loading {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
      }

      /* 空状态 */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #7f8c8d;
      }

      .empty-state h4 {
        font-size: 18px;
        margin-bottom: 10px;
      }

      .empty-state p {
        font-size: 14px;
      }
    </style>
  </head>

  <body>
    <div class="header">
      <h1>摄像头管理系统</h1>
      <p>管理和监控你的RTSP摄像头</p>
    </div>

    <!-- 标签页导航 -->
    <div class="card">
      <div style="border-bottom: 1px solid #ddd; margin-bottom: 20px">
        <div
          style="
            display: flex;
            align-items: center;
            justify-content: space-between;
          "
        >
          <div>
            <button
              class="btn"
              id="camerasTab"
              style="
                border: none;
                background: #3498db;
                color: white;
                margin-right: 10px;
              "
              onclick="switchTab('cameras')"
            >
              摄像头管理
            </button>
            <button
              class="btn"
              id="serversTab"
              style="border: none; background: #95a5a6; color: white"
              onclick="switchTab('servers')"
            >
              推理服务器
            </button>
          </div>
          <div style="display: flex; gap: 10px; align-items: center">
            <button
              class="btn"
              onclick="importConfig()"
              style="
                background: #27ae60;
                color: white;
                padding: 8px 16px;
                font-size: 16px;
              "
            >
              +
            </button>
            <button
              class="btn"
              onclick="exportConfig()"
              style="
                background: #f39c12;
                color: white;
                padding: 8px 16px;
                font-size: 16px;
              "
            >
              &gt;&gt;
            </button>
            <input
              type="file"
              id="configFileInput"
              accept=".json"
              style="display: none"
              onchange="handleFileImport(this)"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- 摄像头管理标签页 -->
    <div id="camerasSection">
      <!-- 添加摄像头表单 -->
      <div class="card">
        <h3>添加摄像头</h3>
        <form id="cameraForm">
          <div class="form-group">
            <label for="cameraName">摄像头名称 *</label>
            <input
              type="text"
              id="cameraName"
              class="form-control"
              placeholder="例如: 前门摄像头"
              required
            />
          </div>
          <div class="form-group">
            <label for="rtspUrl">RTSP地址 *</label>
            <input
              type="text"
              id="rtspUrl"
              class="form-control"
              placeholder="rtsp://username:password@ip:port/path"
              required
            />
          </div>
          <div class="form-group">
            <label for="inferenceServers">推理服务器</label>
            <div
              id="inferenceServersList"
              class="inference-servers-grid"
              style="
                border: 1px solid #ddd;
                border-radius: 6px;
                padding: 10px;
                max-height: 600px;
                overflow-y: auto;
              "
            >
              <div style="color: #7f8c8d; font-size: 14px">
                加载推理服务器列表...
              </div>
            </div>
            <small style="color: #7f8c8d; font-size: 12px"
              >可选：选择一个或多个推理服务器</small
            >
          </div>
          <div class="form-group" style="display: none" id="legacyServerGroup">
            <label for="serverUrl">推理服务器地址（旧版）</label>
            <input
              type="url"
              id="serverUrl"
              class="form-control"
              placeholder="http://localhost:8080/api/detect"
              value=""
            />
            <small style="color: #7f8c8d; font-size: 12px"
              >兼容模式：直接输入推理服务器API地址</small
            >
          </div>
          <button type="submit" class="btn btn-primary">添加摄像头</button>
        </form>
      </div>

      <!-- 摄像头列表 -->
      <div class="card">
        <h3>摄像头列表</h3>
        <div id="camerasLoading" class="loading">
          <p>加载中...</p>
        </div>
        <div id="camerasEmpty" class="empty-state" style="display: none">
          <h4>暂无摄像头</h4>
          <p>请使用上面的表单添加第一个摄像头</p>
        </div>
        <div id="camerasGrid" class="cameras-grid" style="display: none"></div>
      </div>
    </div>

    <!-- 推理服务器管理标签页 -->
    <div id="serversSection" style="display: none">
      <!-- 添加推理服务器表单 -->
      <div class="card">
        <h3>添加推理服务器</h3>
        <form id="serverForm">
          <div class="form-group">
            <label for="serverName">服务器名称 *</label>
            <input
              type="text"
              id="serverName"
              class="form-control"
              placeholder="例如: YOLO检测服务器"
              required
            />
          </div>
          <div class="form-group">
            <label for="serverUrl">服务器地址 *</label>
            <input
              type="url"
              id="serverUrlInput"
              class="form-control"
              placeholder="例如: http://localhost:8080/gesture 或 http://192.168.1.100:8080/fall"
              required
            />
            <small style="color: #7f8c8d; font-size: 12px"
              >直接输入完整的推理服务器地址，包括端点路径</small
            >
          </div>
          <button type="submit" class="btn btn-primary">添加服务器</button>
        </form>
      </div>

      <!-- 推理服务器列表 -->
      <div class="card">
        <h3>推理服务器列表</h3>
        <div id="serversLoading" class="loading">
          <p>加载中...</p>
        </div>
        <div id="serversEmpty" class="empty-state" style="display: none">
          <h4>暂无推理服务器</h4>
          <p>请使用上面的表单添加第一个推理服务器</p>
        </div>
        <div id="serversGrid" class="inference-servers-grid" style="display: none; grid-template-columns: repeat(4, 1fr);"></div>
      </div>
    </div>

    <script>
      class CameraManager {
        constructor() {
          this.apiBase = "/api";
          this.serverMap = {}; // id -> name
          this.init();
        }

        init() {
          this.loadInferenceServersForForm().then(() => {
            this.loadCameras();
          });
          this.setupEventListeners();
        }

        setupEventListeners() {
          document
            .getElementById("cameraForm")
            .addEventListener("submit", (e) => {
              e.preventDefault();
              this.addCamera();
            });
        }

        async loadCameras() {
          try {
            const response = await fetch(`${this.apiBase}/cameras`);
            const result = await response.json();

            if (result.success) {
              this.displayCameras(result.data || []);
            } else {
              console.error("加载摄像头失败:", result.error);
            }
          } catch (error) {
            console.error("网络错误:", error);
          } finally {
            document.getElementById("camerasLoading").style.display = "none";
          }
        }

        displayCameras(cameras) {
          const grid = document.getElementById("camerasGrid");
          const emptyState = document.getElementById("camerasEmpty");

          if (cameras.length === 0) {
            emptyState.style.display = "block";
            grid.style.display = "none";
            return;
          }

          emptyState.style.display = "none";
          grid.style.display = "grid";

          grid.innerHTML = cameras
            .map(
              (camera) => `
                    <div class="camera-card">
                        <div class="camera-header">
                            <div class="camera-name">${this.escapeHtml(camera.name)}</div>
                            <div class="camera-status">
                                <span class="status-indicator ${
                                  camera.running
                                    ? "status-running"
                                    : "status-stopped"
                                }"></span>
                                ${camera.running ? "运行中" : "已停止"}
                            </div>
                        </div>
                        <div class="camera-rtsp">
                            ${this.escapeHtml(camera.rtsp_url)}
                        </div>
                        <div class="camera-servers">
                            ${this.renderInferenceServerBindings(camera)}
                        </div>
                        <div style="font-size: 11px; color: #999; margin-bottom: 12px;">
                            创建于 ${this.formatDate(camera.created_at)}
                        </div>
                        <div class="camera-actions">
                            <button class="btn btn-primary" onclick="cameraManager.editCamera('${
                              camera.id
                            }')">
                                编辑
                            </button>
                            <button class="btn btn-danger" onclick="cameraManager.deleteCamera('${
                              camera.id
                            }')">
                                删除
                            </button>
                        </div>
                    </div>
                `
            )
            .join("");
        }

        async loadInferenceServersForForm() {
          try {
            const response = await fetch(`${this.apiBase}/inference-servers`);
            const result = await response.json();

            if (result.success) {
              const list = result.data || [];
              // build id->name map for rendering elsewhere
              this.serverMap = {};
              list.forEach((s) => {
                this.serverMap[s.id] = s.name;
              });
              this.displayInferenceServersList(list);
              return Promise.resolve();
            } else {
              console.error("加载推理服务器失败:", result.error);
              return Promise.reject(new Error(result.error));
            }
          } catch (error) {
            console.error("网络错误:", error);
            document.getElementById("inferenceServersList").innerHTML = `
                        <div style="color: #e74c3c; font-size: 14px;">加载失败，请刷新页面重试</div>
                    `;
            return Promise.reject(error);
          }
        }

        displayInferenceServersList(servers) {
          const container = document.getElementById("inferenceServersList");

          if (servers.length === 0) {
            container.innerHTML = `
                        <div style="color: #7f8c8d; font-size: 14px; grid-column: 1 / -1; text-align: center;">
                            暂无可用的推理服务器，请先在"推理服务器"标签页中添加
                        </div>
                    `
            return;
          }

          container.innerHTML = servers
            .map(
              (server) => `
                    <div style="margin-bottom: 12px; padding: 8px; border: 1px solid #eee; border-radius: 6px; background: #fafafa; position: relative;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
                            <div style="font-size: 12px; color: #333; font-weight: 500;">
                                ${this.escapeHtml(server.name)}
                            </div>
                            <input type="checkbox" name="inferenceServer" value="${
                              server.id
                            }" style="margin: 0;" onchange="toggleThresholdInput('${
              server.id
            }')">
                        </div>
                        <div style="font-size: 11px; color: #999; background: #f8f9fa; padding: 2px 4px; border-radius: 3px;">
                            ${this.escapeHtml(server.url)}
                        </div>
                        <div id="threshold-${
                          server.id
                        }" style="display: none; margin-left: 24px;">
                            <div style="margin-bottom: 8px;">
                                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">置信度区间: <span id="threshold-range-${
                                  server.id
                                }">50% - 100%</span></label>
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <label style="font-size: 11px; color: #666; min-width: 30px;">最小:</label>
                                    <input type="range" name="threshold-${
                                      server.id
                                    }" min="0" max="100" value="50" 
                                           style="flex: 1;" 
                                           oninput="updateThresholdRange('${
                server.id
              }')">
                                    <span style="font-size: 11px; color: #666; min-width: 40px;" id="threshold-min-${
                                      server.id
                                    }">50%</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="font-size: 11px; color: #666; min-width: 30px;">最大:</label>
                                    <input type="range" name="max-threshold-${
                                      server.id
                                    }" min="0" max="100" value="100" 
                                           style="flex: 1;" 
                                           oninput="updateThresholdRange('${
                server.id
              }')">
                                    <span style="font-size: 11px; color: #666; min-width: 40px;" id="threshold-max-${
                                      server.id
                                    }">100%</span>
                                </div>
                            </div>
                            <div style="font-size: 11px; color: #999;">
                                检测置信度在此区间内时保存图片
                            </div>
                        </div>
                    </div>
                `
            )
            .join("");
        }

        async addCamera() {
          const name = document.getElementById("cameraName").value.trim();
          const rtspUrl = document.getElementById("rtspUrl").value.trim();
          const serverUrl = document.getElementById("serverUrl").value.trim();

          // 获取选中的推理服务器
          const selectedServers = Array.from(
            document.querySelectorAll('input[name="inferenceServer"]:checked')
          ).map((checkbox) => checkbox.value);

          if (!name || !rtspUrl) {
            alert("请填写所有必填字段");
            return;
          }

          const cameraData = {
            name: name,
            rtsp_url: rtspUrl,
            enabled: true,
            running: true,
          };

          // 使用新的服务器绑定模式（包含阈值）
          if (selectedServers.length > 0) {
            const bindings = selectedServers.map((serverId) => {
              const thresholdInput = document.querySelector(
                `input[name="threshold-${serverId}"]`
              );
              const maxThresholdInput = document.querySelector(
                `input[name="max-threshold-${serverId}"]`
              );
              const threshold = thresholdInput
                ? parseFloat(thresholdInput.value) / 100.0
                : 0.5;
              const maxThreshold = maxThresholdInput
                ? parseFloat(maxThresholdInput.value) / 100.0
                : 1.0;
              return {
                server_id: serverId,
                threshold: threshold,
                max_threshold: maxThreshold === 1.0 ? 0 : maxThreshold, // 0 means no max limit
              };
            });
            cameraData.inference_server_bindings = bindings;
          } else if (serverUrl) {
            // 向后兼容：使用旧的单服务器模式
            cameraData.server_url = serverUrl;
          }

          try {
            const response = await fetch(`${this.apiBase}/cameras`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(cameraData),
            });

            const result = await response.json();

            if (result.success) {
              // 重新加载摄像头列表
              this.loadCameras();
              alert("摄像头添加成功并已自动启动！");
            } else {
              alert("添加摄像头失败: " + (result.error || result.message));
            }
          } catch (error) {
            console.error("网络错误:", error);
            alert("网络错误，请稍后重试");
          }
        }

        async editCamera(cameraId) {
          try {
            // 获取摄像头当前配置
            const response = await fetch(`${this.apiBase}/cameras/${cameraId}`);
            const result = await response.json();

            if (!result.success) {
              alert("获取摄像头信息失败: " + (result.error || result.message));
              return;
            }

            const camera = result.data;
            this.showEditDialog(camera);
          } catch (error) {
            console.error("网络错误:", error);
            alert("网络错误，请稍后重试");
          }
        }

        showEditDialog(camera) {
          // 创建编辑对话框
          const dialog = document.createElement("div");
          dialog.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                `;

          dialog.innerHTML = `
                    <div class="large-modal" style="background: white; padding: 30px; border-radius: 12px; overflow-y: auto;">
                        <h3 style="margin-bottom: 20px; color: #2c3e50;">编辑摄像头: ${this.escapeHtml(
                          camera.name
                        )}</h3>
                        <form id="editCameraForm">
                            <div class="form-group">
                                <label>摄像头名称 *</label>
                                <input type="text" id="editCameraName" class="form-control" value="${this.escapeHtml(
                                  camera.name
                                )}" required>
                            </div>
                            <div class="form-group">
                                <label>RTSP地址 *</label>
                                <input type="text" id="editRtspUrl" class="form-control" value="${this.escapeHtml(
                                  camera.rtsp_url
                                )}" required>
                            </div>
                            <div class="form-group">
                                <label>推理服务器绑定</label>
                                <div id="editInferenceServersList" class="inference-servers-grid" style="border: 1px solid #ddd; border-radius: 6px; padding: 10px; height: 420px; overflow-y: auto; overflow-x: hidden;">
                                    <div style="color: #7f8c8d; font-size: 14px; grid-column: 1 / -1; text-align: center;">加载中...</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                                <button type="button" class="btn" style="background: #95a5a6; color: white;" onclick="this.parentElement.parentElement.parentElement.parentElement.remove()">取消</button>
                                <button type="submit" class="btn btn-primary">保存</button>
                            </div>
                        </form>
                    </div>
                `

          document.body.appendChild(dialog);

          // 加载推理服务器列表为编辑对话框
          this.loadInferenceServersForEdit(camera);

          // 设置表单提交事件
          document
            .getElementById("editCameraForm")
            .addEventListener("submit", (e) => {
              e.preventDefault();
              this.updateCamera(camera.id, dialog);
            });

          // 点击外部关闭对话框
          dialog.addEventListener("click", (e) => {
            if (e.target === dialog) {
              dialog.remove();
            }
          });
        }

        async loadInferenceServersForEdit(camera) {
          try {
            const response = await fetch(`${this.apiBase}/inference-servers`);
            const result = await response.json();

            if (result.success) {
              this.displayInferenceServersListForEdit(
                result.data || [],
                camera
              );
            } else {
              document.getElementById("editInferenceServersList").innerHTML = `
                            <div style="color: #e74c3c; font-size: 14px;">加载失败</div>
                        `;
            }
          } catch (error) {
            document.getElementById("editInferenceServersList").innerHTML = `
                        <div style="color: #e74c3c; font-size: 14px;">网络错误</div>
                    `;
          }
        }

        displayInferenceServersListForEdit(servers, camera) {
          const container = document.getElementById("editInferenceServersList");

          if (servers.length === 0) {
            container.innerHTML = `
                        <div style="color: #7f8c8d; font-size: 14px; grid-column: 1 / -1; text-align: center;">暂无可用的推理服务器</div>
                    `;
            return;
          }

          // 获取当前摄像头的绑定信息
          const currentBindings = camera.inference_server_bindings || [];
          const bindingMap = {};
          currentBindings.forEach((binding) => {
            bindingMap[binding.server_id] = {
              threshold: binding.threshold,
              max_threshold: binding.max_threshold || 0,
            };
          });

          container.innerHTML = servers
            .map((server) => {
              const isSelected = bindingMap.hasOwnProperty(server.id);
              const threshold = isSelected
                ? Math.round(bindingMap[server.id].threshold * 100)
                : 50;
              const maxThreshold =
                isSelected && bindingMap[server.id].max_threshold > 0
                  ? Math.round(bindingMap[server.id].max_threshold * 100)
                  : 100;

              return `
                        <div style="
                            margin-bottom: 12px; 
                            padding: 8px; 
                            border: 1px solid #eee; 
                            border-radius: 6px; 
                            background: #fafafa;
                            height: 180px;
                            display: flex;
                            flex-direction: column;
                            position: relative;
                        ">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
                                <div style="font-size: 12px; color: #333; font-weight: 500;">
                                    ${this.escapeHtml(server.name)}
                                </div>
                                <input type="checkbox" name="editInferenceServer" value="${
                                  server.id
                                }" 
                                       ${isSelected ? "checked" : ""} 
                                       style="margin: 0;" 
                                       onchange="toggleEditThresholdInput('${
                                         server.id
                                       }')">
                            </div>
                            <div style="font-size: 11px; color: #999; background: #f8f9fa; padding: 2px 4px; border-radius: 3px; margin-bottom: 8px;">
                                ${this.escapeHtml(server.url)}
                            </div>
                            <div id="edit-threshold-${
                              server.id
                            }" style="display: ${
                isSelected ? "block" : "none"
              }; flex: 1; overflow: hidden;">
                                <div style="margin-bottom: 8px;">
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">置信度区间: <span id="edit-threshold-range-${
                                      server.id
                                    }">${threshold}% - ${maxThreshold}%</span></label>
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                        <label style="font-size: 11px; color: #666; min-width: 30px;">最小:</label>
                                        <input type="range" name="edit-threshold-${
                                          server.id
                                        }" min="0" max="100" value="${threshold}" 
                                               style="flex: 1;" 
                                               oninput="updateEditThresholdRange('${
                  server.id
                }')">
                                        <span style="font-size: 11px; color: #666; min-width: 40px;" id="edit-threshold-min-${
                                          server.id
                                        }">${threshold}%</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <label style="font-size: 11px; color: #666; min-width: 30px;">最大:</label>
                                        <input type="range" name="edit-max-threshold-${
                                          server.id
                                        }" min="0" max="100" value="${maxThreshold}" 
                                               style="flex: 1;" 
                                               oninput="updateEditThresholdRange('${
                  server.id
                }')">
                                        <span style="font-size: 11px; color: #666; min-width: 40px;" id="edit-threshold-max-${
                                          server.id
                                        }">${maxThreshold}%</span>
                                    </div>
                                </div>
                                <div style="font-size: 11px; color: #999;">
                                    检测置信度在此区间内时保存图片
                                </div>
                            </div>
                        </div>
                    `;
            })
            .join("");
        }

        async updateCamera(cameraId, dialog) {
          const name = document.getElementById("editCameraName").value.trim();
          const rtspUrl = document.getElementById("editRtspUrl").value.trim();

          if (!name || !rtspUrl) {
            alert("请填写所有必填字段");
            return;
          }

          // 获取选中的推理服务器
          const selectedServers = Array.from(
            document.querySelectorAll(
              'input[name="editInferenceServer"]:checked'
            )
          ).map((checkbox) => checkbox.value);

          const cameraData = {
            name: name,
            rtsp_url: rtspUrl,
            enabled: true,
            running: true,
          };

          // 使用新的服务器绑定模式（包含阈值）
          if (selectedServers.length > 0) {
            const bindings = selectedServers.map((serverId) => {
              const thresholdInput = document.querySelector(
                `input[name="edit-threshold-${serverId}"]`
              );
              const maxThresholdInput = document.querySelector(
                `input[name="edit-max-threshold-${serverId}"]`
              );
              const threshold = thresholdInput
                ? parseFloat(thresholdInput.value) / 100.0
                : 0.5;
              const maxThreshold = maxThresholdInput
                ? parseFloat(maxThresholdInput.value) / 100.0
                : 1.0;
              return {
                server_id: serverId,
                threshold: threshold,
                max_threshold: maxThreshold === 1.0 ? 0 : maxThreshold, // 0 means no max limit
              };
            });
            cameraData.inference_server_bindings = bindings;
          } else {
            // 清空绑定
            cameraData.inference_server_bindings = [];
          }

          try {
            const response = await fetch(
              `${this.apiBase}/cameras/${cameraId}`,
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(cameraData),
              }
            );

            const result = await response.json();

            if (result.success) {
              dialog.remove();
              this.loadCameras();
              alert("摄像头更新成功！");
            } else {
              alert("更新摄像头失败: " + (result.error || result.message));
            }
          } catch (error) {
            console.error("网络错误:", error);
            alert("网络错误，请稍后重试");
          }
        }

        async deleteCamera(cameraId) {
          if (!confirm("确定要删除这个摄像头吗？此操作无法撤销。")) {
            return;
          }

          try {
            const response = await fetch(
              `${this.apiBase}/cameras/${cameraId}`,
              {
                method: "DELETE",
              }
            );

            const result = await response.json();

            if (result.success) {
              this.loadCameras();
              alert("摄像头删除成功！");
            } else {
              alert("删除摄像头失败: " + (result.error || result.message));
            }
          } catch (error) {
            console.error("网络错误:", error);
            alert("网络错误，请稍后重试");
          }
        }

        escapeHtml(text) {
          const div = document.createElement("div");
          div.textContent = text;
          return div.innerHTML;
        }

        formatDate(dateString) {
          try {
            const date = new Date(dateString);
            return date.toLocaleString("zh-CN");
          } catch (error) {
            return dateString;
          }
        }

        renderInferenceServerBindings(camera) {
          // Handle both new binding format and legacy format
          if (
            camera.inference_server_bindings &&
            camera.inference_server_bindings.length > 0
          ) {
            return camera.inference_server_bindings
              .map((binding) => {
                const name = this.serverMap[binding.server_id];
                const serverName = name || binding.server_id;
                const minThreshold = Math.round(binding.threshold * 100);
                const maxThreshold = binding.max_threshold > 0 ? Math.round(binding.max_threshold * 100) : 100;
                return `
                        <div style="margin-bottom: 4px; font-size: 12px; color: #666;">
                            ${this.escapeHtml(serverName)} (${minThreshold}% - ${maxThreshold}%)
                        </div>
                    `;
              })
              .join("");
          } else if (camera.server_url) {
            // Legacy single server format
            return `<code style="font-size: 11px; background: #e8f5e8; padding: 2px 6px; border-radius: 3px; color: #2d7d2d;">
                        ${this.escapeHtml(camera.server_url)}
                    </code>`;
          } else {
            return `<span style="color: #95a5a6; font-size: 12px;">未设置</span>`;
          }
        }

      }

      class InferenceServerManager {
        constructor() {
          this.apiBase = "/api";
        }

        async loadServers() {
          try {
            const response = await fetch(`${this.apiBase}/inference-servers`);
            const result = await response.json();

            if (result.success) {
              this.displayServers(result.data || []);
            } else {
              console.error("加载推理服务器失败:", result.error);
            }
          } catch (error) {
            console.error("网络错误:", error);
          } finally {
            document.getElementById("serversLoading").style.display = "none";
          }
        }

        displayServers(servers) {
          const grid = document.getElementById("serversGrid");
          const emptyState = document.getElementById("serversEmpty");

          if (servers.length === 0) {
            emptyState.style.display = "block";
            grid.style.display = "none";
            return;
          }

          emptyState.style.display = "none";
          grid.style.display = "grid";

          grid.innerHTML = servers
            .map(
              (server) => `
                    <div class="camera-card" style="position: relative; background: white; border: 1px solid #e1e8ed; border-radius: 8px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: box-shadow 0.2s;">
                        <button class="server-delete-btn" onclick="serverManager.deleteServer('${
                          server.id
                        }')">删除</button>
                        <div class="camera-header" style="display: flex; align-items: center; margin-bottom: 12px;">
                            <div class="camera-name" style="font-weight: 600; font-size: 16px; color: #2c3e50; margin-right: 12px; flex: 1;">
                                ${this.escapeHtml(server.name)}
                            </div>
                            <div class="camera-status" style="display: flex; align-items: center; font-size: 12px; color: #666;">
                                <span class="status-indicator status-running"></span>
                                启用
                            </div>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <span style="background: #e8f4fd; color: #1e88e5; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                ${this.escapeHtml(server.model_type)}
                            </span>
                        </div>
                        <div style="font-size: 11px; color: #999; margin-bottom: 8px;">
                            <code style="background: #f0f0f0; padding: 2px 4px; border-radius: 3px; font-family: monospace;">${server.id}</code>
                        </div>
                        <div class="camera-rtsp" style="font-size: 11px; color: #666; background: #f8f9fa; padding: 4px 8px; border-radius: 4px; margin-bottom: 12px; word-break: break-all;">
                            ${this.escapeHtml(server.url)}
                        </div>
                        <div style="font-size: 11px; color: #999; margin-bottom: 12px;">
                            创建于 ${this.formatDate(server.created_at)}
                        </div>
                    </div>
                `
            )
            .join("");
        }

        async addServer() {
          const name = document.getElementById("serverName").value.trim();
          const url = document.getElementById("serverUrlInput").value.trim();
          if (!name || !url) {
            alert("请填写服务器名称和地址字段");
            return;
          }

          // 验证服务器名称只能包含英文字母、数字、下划线和连字符
          const namePattern = /^[a-zA-Z0-9_-]+$/;
          if (!namePattern.test(name)) {
            alert("服务器名称只能包含英文字母、数字、下划线和连字符");
            return;
          }

          // 解析URL并处理modeltype查询参数
          let modelType = "auto";
          let cleanUrl = url;
          try {
            const urlObj = new URL(url);
            
            // 检查是否有modeltype查询参数
            const modelTypeParam = urlObj.searchParams.get("modeltype");
            if (modelTypeParam) {
              // 使用查询参数中的modeltype
              modelType = modelTypeParam;
              // 移除查询参数，生成干净的URL
              urlObj.searchParams.delete("modeltype");
              cleanUrl = urlObj.toString();
            } else {
              // 没有查询参数，使用路径的最后一段作为modeltype
              const pathParts = urlObj.pathname.split("/").filter((part) => part);
              if (pathParts.length > 0) {
                modelType = pathParts[pathParts.length - 1];
              }
            }
          } catch (error) {
            console.log("URL解析失败，使用默认的 auto 类型");
          }

          const serverData = {
            name: name,
            url: cleanUrl, // 使用处理后的干净URL
            model_type: modelType,
          };

          try {
            const response = await fetch(`${this.apiBase}/inference-servers`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(serverData),
            });

            const result = await response.json();

            if (result.success) {
              this.loadServers();
              alert("推理服务器添加成功！");
            } else {
              alert("添加推理服务器失败: " + (result.error || result.message));
            }
          } catch (error) {
            console.error("网络错误:", error);
            alert("网络错误，请稍后重试");
          }
        }

        async deleteServer(serverId) {
          if (!confirm("确定要删除这个推理服务器吗？此操作无法撤销。")) {
            return;
          }

          try {
            const response = await fetch(
              `${this.apiBase}/inference-servers/${serverId}`,
              {
                method: "DELETE",
              }
            );

            const result = await response.json();

            if (result.success) {
              this.loadServers();
              alert("推理服务器删除成功！");
            } else {
              alert("删除推理服务器失败: " + (result.error || result.message));
            }
          } catch (error) {
            console.error("网络错误:", error);
            alert("网络错误，请稍后重试");
          }
        }

        escapeHtml(text) {
          const div = document.createElement("div");
          div.textContent = text;
          return div.innerHTML;
        }

        formatDate(dateString) {
          try {
            const date = new Date(dateString);
            return date.toLocaleString("zh-CN");
          } catch (error) {
            return dateString;
          }
        }
      }

      // 标签页切换功能
      function switchTab(tab) {
        const camerasTab = document.getElementById("camerasTab");
        const serversTab = document.getElementById("serversTab");
        const camerasSection = document.getElementById("camerasSection");
        const serversSection = document.getElementById("serversSection");

        if (tab === "cameras") {
          camerasTab.style.background = "#3498db";
          serversTab.style.background = "#95a5a6";
          camerasSection.style.display = "block";
          serversSection.style.display = "none";
        } else if (tab === "servers") {
          camerasTab.style.background = "#95a5a6";
          serversTab.style.background = "#3498db";
          camerasSection.style.display = "none";
          serversSection.style.display = "block";
          serverManager.loadServers();
        }
      }

      // 初始化管理器
      const cameraManager = new CameraManager();
      const serverManager = new InferenceServerManager();

      // 设置推理服务器表单事件监听
      document.getElementById("serverForm").addEventListener("submit", (e) => {
        e.preventDefault();
        serverManager.addServer();
      });

      // 阈值管理功能
      function toggleThresholdInput(serverId) {
        const checkbox = document.querySelector(
          `input[name="inferenceServer"][value="${serverId}"]`
        );
        const thresholdDiv = document.getElementById(`threshold-${serverId}`);

        if (checkbox && thresholdDiv) {
          thresholdDiv.style.display = checkbox.checked ? "block" : "none";
        }
      }

      function updateThresholdValue(serverId, value) {
        const valueSpan = document.getElementById(
          `threshold-value-${serverId}`
        );
        if (valueSpan) {
          valueSpan.textContent = `${value}%`;
        }
      }

      // 编辑对话框中的阈值管理功能
      function toggleEditThresholdInput(serverId) {
        const checkbox = document.querySelector(
          `input[name="editInferenceServer"][value="${serverId}"]`
        );
        const thresholdDiv = document.getElementById(
          `edit-threshold-${serverId}`
        );

        if (checkbox && thresholdDiv) {
          thresholdDiv.style.display = checkbox.checked ? "block" : "none";
        }
      }

      function updateEditThresholdValue(serverId, value) {
        const valueSpan = document.getElementById(
          `edit-threshold-value-${serverId}`
        );
        if (valueSpan) {
          valueSpan.textContent = `${value}%`;
        }
      }

      // 最大阈值管理功能
      function updateMaxThresholdValue(serverId, value) {
        const valueSpan = document.getElementById(
          `max-threshold-value-${serverId}`
        );
        if (valueSpan) {
          valueSpan.textContent = `${value}%`;
        }
      }

      function updateEditMaxThresholdValue(serverId, value) {
        const valueSpan = document.getElementById(
          `edit-max-threshold-value-${serverId}`
        );
        if (valueSpan) {
          valueSpan.textContent = `${value}%`;
        }
      }

      // 区间滑块更新函数
      function updateThresholdRange(serverId) {
        const minInput = document.querySelector(`input[name="threshold-${serverId}"]`);
        const maxInput = document.querySelector(`input[name="max-threshold-${serverId}"]`);
        const rangeSpan = document.getElementById(`threshold-range-${serverId}`);
        const minSpan = document.getElementById(`threshold-min-${serverId}`);
        const maxSpan = document.getElementById(`threshold-max-${serverId}`);
        
        if (minInput && maxInput && rangeSpan) {
          const minValue = parseInt(minInput.value);
          const maxValue = parseInt(maxInput.value);
          
          // Ensure min <= max
          if (minValue > maxValue) {
            maxInput.value = minValue;
          }
          
          rangeSpan.textContent = `${minInput.value}% - ${maxInput.value}%`;
          if (minSpan) minSpan.textContent = `${minInput.value}%`;
          if (maxSpan) maxSpan.textContent = `${maxInput.value}%`;
        }
      }

      function updateEditThresholdRange(serverId) {
        const minInput = document.querySelector(`input[name="edit-threshold-${serverId}"]`);
        const maxInput = document.querySelector(`input[name="edit-max-threshold-${serverId}"]`);
        const rangeSpan = document.getElementById(`edit-threshold-range-${serverId}`);
        const minSpan = document.getElementById(`edit-threshold-min-${serverId}`);
        const maxSpan = document.getElementById(`edit-threshold-max-${serverId}`);
        
        if (minInput && maxInput && rangeSpan) {
          const minValue = parseInt(minInput.value);
          const maxValue = parseInt(maxInput.value);
          
          // Ensure min <= max
          if (minValue > maxValue) {
            maxInput.value = minValue;
          }
          
          rangeSpan.textContent = `${minInput.value}% - ${maxInput.value}%`;
          if (minSpan) minSpan.textContent = `${minInput.value}%`;
          if (maxSpan) maxSpan.textContent = `${maxInput.value}%`;
        }
      }

      // 配置导入导出功能
      function importConfig() {
        // 点击文件输入按钮进行导入
        document.getElementById("configFileInput").click();
      }

      function exportConfig() {
        // 导出配置到文件
        const apiBase = "/api";
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').replace('T', '_').substring(0, 19);
        const link = document.createElement("a");
        link.href = `${apiBase}/config/export`;
        link.download = `cameras_${timestamp}.json`;
        link.click();
      }

      async function handleFileImport(input) {
        const file = input.files[0];
        if (!file) {
          return;
        }

        if (!file.name.toLowerCase().endsWith(".json")) {
          alert("请选择JSON配置文件");
          return;
        }

        if (!confirm("导入配置将替换当前所有设置，是否继续？")) {
          input.value = ""; // 清空文件选择
          return;
        }

        const formData = new FormData();
        formData.append("file", file);

        try {
          const response = await fetch("/api/config/import", {
            method: "POST",
            body: await file.text(), // 直接传送JSON数据
          });

          const result = await response.json();

          if (result.success) {
            alert(
              `配置导入成功！已导入 ${result.data.cameras_count} 个摄像头和 ${result.data.inference_servers_count} 个推理服务器。`
            );
            // 重新加载数据 - 先加载服务器再加载摄像头以确保serverMap正确更新
            cameraManager.loadInferenceServersForForm().then(() => {
              cameraManager.loadCameras();
            });
          } else {
            alert("导入配置失败: " + (result.error || result.message));
          }
        } catch (error) {
          console.error("导入错误:", error);
          alert("导入配置时发生错误，请检查文件格式");
        } finally {
          input.value = ""; // 清空文件选择
        }
      }
    </script>
  </body>
</html>
