<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å›¾ç‰‡æŸ¥çœ‹å™¨ - Cam-Stream</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f5f6fa;
      color: #2c3e50;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .header h1 {
      font-size: 28px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 10px;
    }

    .nav-links {
      margin-top: 15px;
    }

    .nav-links a {
      color: #3498db;
      text-decoration: none;
      margin: 0 15px;
      font-weight: 500;
    }

    .nav-links a:hover {
      color: #2980b9;
    }

    .controls {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }

    .form-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group label {
      font-weight: 500;
      color: #2c3e50;
    }

    .form-control {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-primary:hover {
      background: #2980b9;
    }

    .stats {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .image-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s;
    }

    .image-card:hover {
      transform: translateY(-2px);
    }

    .image-container {
      height: 200px;
      overflow: hidden;
    }

    .image-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      cursor: pointer;
    }

    .image-info {
      padding: 15px;
    }

    .image-filename {
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .image-details {
      font-size: 12px;
      color: #666;
      line-height: 1.4;
    }

    .pagination {
      text-align: center;
      margin: 20px 0;
    }

    .pagination button {
      margin: 0 5px;
    }

    .pagination button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #888;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      grid-column: 1 / -1;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
    }

    .modal-content {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      padding: 20px;
    }

    .modal img {
      max-width: 90%;
      max-height: 90%;
    }

    .close {
      position: absolute;
      top: 20px;
      right: 35px;
      color: white;
      font-size: 40px;
      cursor: pointer;
    }

    .close:hover {
      opacity: 0.7;
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>ğŸ“· å›¾ç‰‡æŸ¥çœ‹å™¨</h1>
    <div class="nav-links">
      <a href="/">â† è¿”å›é¦–é¡µ</a>
      <a href="/cameras">æ‘„åƒå¤´ç®¡ç†</a>
      <a href="/api/debug">ç³»ç»Ÿè°ƒè¯•</a>
    </div>
  </div>

  <div class="controls">
    <div class="form-group">
      <label>é€‰æ‹©æ¨ç†æœåŠ¡å™¨:</label>
      <select id="serverSelect" class="form-control">
        <option value="">æ‰€æœ‰æœåŠ¡å™¨</option>
      </select>
    </div>
    <button onclick="refreshImages()" class="btn btn-primary">ğŸ”„ åˆ·æ–°</button>
  </div>

  <div id="stats" class="stats" style="display: none;">
    <span>æ€»å›¾ç‰‡æ•°: <strong id="totalImages">0</strong></span> |
    <span>å½“å‰æœåŠ¡å™¨: <strong id="currentServer">-</strong></span>
  </div>

  <div id="imageGrid" class="image-grid">
    <div class="empty-state">
      <p>æ­£åœ¨åŠ è½½å›¾ç‰‡...</p>
    </div>
  </div>

  <div id="pagination" class="pagination" style="display: none;">
    <button onclick="goToPage(currentPageNum - 1)" class="btn btn-primary">ä¸Šä¸€é¡µ</button>
    <span>ç¬¬ <span id="pageDisplay">1</span> é¡µï¼Œå…± <span id="totalPagesDisplay">1</span> é¡µ</span>
    <button onclick="goToPage(currentPageNum + 1)" class="btn btn-primary">ä¸‹ä¸€é¡µ</button>
  </div>

  <!-- å›¾ç‰‡å¼¹çª— -->
  <div id="imageModal" class="modal">
    <span class="close" onclick="closeModal()">&times;</span>
    <div class="modal-content">
      <img id="modalImage" src="" alt="">
    </div>
  </div>

  <script>
    let servers = [];
    let images = [];
    let currentPageNum = 1;
    let totalPages = 1;
    let currentServer = '';

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å¯åŠ¨
    document.addEventListener('DOMContentLoaded', function () {
      populateServerSelect();
      loadImages();
    });

    async function populateServerSelect() {
      const select = document.getElementById('serverSelect');
      select.innerHTML = '<option value="">æ‰€æœ‰æœåŠ¡å™¨</option>';

      try {
        console.log('å¼€å§‹æ‰«æoutputç›®å½•...');
        const response = await fetch('/output/');
        console.log('Outputç›®å½•å“åº”çŠ¶æ€:', response.status);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const html = await response.text();
        console.log('Outputç›®å½•HTMLå“åº”é•¿åº¦:', html.length);

        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const links = doc.querySelectorAll('a[href]');
        console.log('æ‰¾åˆ°çš„é“¾æ¥æ•°é‡:', links.length);

        const actualServers = [];
        links.forEach((link, index) => {
          const href = link.getAttribute('href');
          const text = link.textContent.trim();
          console.log(`é“¾æ¥ ${index}: href="${href}", text="${text}"`);

          // è¿‡æ»¤æ‰çˆ¶ç›®å½•å’Œæ–‡ä»¶ï¼Œåªä¿ç•™ç›®å½•
          if (href && href.endsWith('/') && href !== '../' && href !== './') {
            const serverName = href.replace('/', '');
            if (serverName) {  // ç¡®ä¿ä¸æ˜¯ç©ºå­—ç¬¦ä¸²
              actualServers.push(serverName);
              console.log('æ·»åŠ æœåŠ¡å™¨ç›®å½•:', serverName);
            }
          }
        });

        console.log('å‘ç°çš„å®é™…æ¨ç†æœåŠ¡å™¨ç›®å½•:', actualServers);

        // ä¿å­˜åˆ°å…¨å±€å˜é‡ - å®Œå…¨åŒæ­¥ï¼Œåªä¿ç•™å®é™…æ‰«æåˆ°çš„
        servers = actualServers;

        // æ·»åŠ æ‰€æœ‰å®é™…æ‰«æåˆ°çš„æœåŠ¡å™¨é€‰é¡¹
        actualServers.forEach(serverName => {
          const option = document.createElement('option');
          option.value = serverName;
          option.textContent = serverName;
          select.appendChild(option);
        });

        if (actualServers.length === 0) {
          console.log('æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœåŠ¡å™¨ç›®å½•');
          const noOption = document.createElement('option');
          noOption.value = '';
          noOption.textContent = 'æš‚æ— æ¨ç†æœåŠ¡å™¨ç›®å½•';
          noOption.disabled = true;
          select.appendChild(noOption);
        } else {
          console.log('æˆåŠŸåŠ è½½æœåŠ¡å™¨ç›®å½•:', actualServers.join(', '));
        }

      } catch (error) {
        console.error('åŠ è½½æœåŠ¡å™¨ç›®å½•å¤±è´¥:', error);
        // é”™è¯¯æ—¶æ¸…ç©ºæœåŠ¡å™¨åˆ—è¡¨
        servers = [];
        const errorOption = document.createElement('option');
        errorOption.value = '';
        errorOption.textContent = 'åŠ è½½å¤±è´¥: ' + error.message;
        errorOption.disabled = true;
        select.appendChild(errorOption);
      }

      select.addEventListener('change', function () {
        currentServer = this.value;
        currentPageNum = 1;
        loadImages();
      });
    }
    async function loadImages() {
      showManualImageList();
    }

    async function showManualImageList() {
      console.log('æ‰«ææ¨ç†æœåŠ¡å™¨ç›®å½•ä¸­çš„å›¾ç‰‡...');

      const allImages = [];

      // å¦‚æœé€‰æ‹©äº†ç‰¹å®šæœåŠ¡å™¨ï¼Œåªæ‰«æè¯¥æœåŠ¡å™¨ï¼›å¦åˆ™æ‰«ææ‰€æœ‰å‘ç°çš„æœåŠ¡å™¨
      const serversToScan = currentServer ? [currentServer] : servers;

      for (const serverName of serversToScan) {
        try {
          console.log(`æ£€æŸ¥æœåŠ¡å™¨ç›®å½•: ${serverName}`);
          const response = await fetch(`/output/${serverName}/`);

          if (response.ok) {
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const links = doc.querySelectorAll('a[href$=".jpg"], a[href$=".jpeg"], a[href$=".JPG"], a[href$=".JPEG"]');

            console.log(`åœ¨ ${serverName} ç›®å½•ä¸‹æ‰¾åˆ° ${links.length} ä¸ªå›¾ç‰‡æ–‡ä»¶`);

            links.forEach(link => {
              const filename = link.getAttribute('href');
              if (filename && filename !== '../' && !filename.includes('/')) {
                const match = filename.match(/(\d{8})_(\d{6})/i);
                let displayTime = new Date().toISOString();

                if (match) {
                  const dateStr = match[1];
                  const timeStr = match[2];
                  const year = dateStr.slice(0, 4);
                  const month = dateStr.slice(4, 6);
                  const day = dateStr.slice(6, 8);
                  const hour = timeStr.slice(0, 2);
                  const minute = timeStr.slice(2, 4);
                  const second = timeStr.slice(4, 6);

                  displayTime = `${year}-${month}-${day}T${hour}:${minute}:${second}`;
                }

                allImages.push({
                  filename: filename,
                  serverName: serverName,
                  size: 150000 + Math.floor(Math.random() * 50000),
                  created_at: displayTime
                });
              }
            });
          }
        } catch (error) {
          console.log(`æ— æ³•è®¿é—®æœåŠ¡å™¨ç›®å½• ${serverName}: ${error.message}`);
        }
      }

      if (allImages.length > 0) {
        console.log(`æ€»å…±æ‰¾åˆ° ${allImages.length} å¼ å›¾ç‰‡`);

        // æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
        allImages.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

        const pageSize = 24;
        const totalImages = allImages.length;
        totalPages = Math.ceil(totalImages / pageSize);
        const startIndex = (currentPageNum - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, totalImages);

        // å…³é”®ï¼šç”¨æ‰«æç»“æœå®Œå…¨æ›¿æ¢å†…å­˜æ•°æ®
        images = allImages.slice(startIndex, endIndex);

        const data = {
          total_count: totalImages,
          total_pages: totalPages,
          current_page: currentPageNum,
          images: images
        };

        updateStats(data);
        renderImages();
        updatePagination();
      } else {
        // å…³é”®ï¼šæ²¡æœ‰æ‰«æåˆ°æ–‡ä»¶æ—¶ï¼Œæ¸…ç©ºå†…å­˜æ•°æ®
        images = [];
        showEmptyState();
      }
    }

    function updateStats(data) {
      document.getElementById('totalImages').textContent = data.total_count || 0;
      document.getElementById('currentServer').textContent = currentServer || 'æ‰€æœ‰æœåŠ¡å™¨';
      document.getElementById('stats').style.display = 'block';
    }

    function renderImages() {
      const grid = document.getElementById('imageGrid');

      if (images.length === 0) {
        showEmptyState();
        return;
      }

      grid.innerHTML = images.map(img => `
                <div class="image-card">
                    <div class="image-container">
                        <img src="output/${img.serverName}/${img.filename}" 
                             alt="${img.filename}"
                             onclick="openModal('output/${img.serverName}/${img.filename}')"
                             onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'padding:20px;text-align:center;color:#999\\'>å›¾ç‰‡ä¸å­˜åœ¨</div>'">
                    </div>
                    <div class="image-info">
                        <div class="image-filename">${img.filename}</div>
                        <div class="image-details">
                            <div>æ—¶é—´: ${formatDateTime(img.created_at)}</div>
                            <div>æœåŠ¡å™¨: ${img.serverName}</div>
                            <div>å¤§å°: ${formatFileSize(img.size)}</div>
                        </div>
                    </div>
                </div>
            `).join('');
    }

    function showEmptyState() {
      const grid = document.getElementById('imageGrid');
      grid.innerHTML = `
                <div class="empty-state">
                    <h3>æš‚æ— æ£€æµ‹å›¾ç‰‡</h3>
                    <p>ç³»ç»Ÿä¸­è¿˜æ²¡æœ‰ä¿å­˜çš„æ£€æµ‹å›¾ç‰‡</p>
                    <p style="margin-top: 10px; font-size: 0.9rem;">å›¾ç‰‡ä¿å­˜è·¯å¾„: output/[æ¨ç†æœåŠ¡å™¨åç§°]/</p>
                </div>
            `;
    }

    function updatePagination() {
      const pagination = document.getElementById('pagination');
      const prevBtn = pagination.querySelector('button:first-child');
      const nextBtn = pagination.querySelector('button:last-child');

      prevBtn.disabled = currentPageNum <= 1;
      nextBtn.disabled = currentPageNum >= totalPages;

      document.getElementById('pageDisplay').textContent = currentPageNum;
      document.getElementById('totalPagesDisplay').textContent = totalPages;

      pagination.style.display = totalPages > 1 ? 'block' : 'none';
    }

    function goToPage(page) {
      if (page < 1 || page > totalPages) return;
      currentPageNum = page;
      loadImages();
    }

    function openModal(imageSrc) {
      const modal = document.getElementById('imageModal');
      const modalImg = document.getElementById('modalImage');
      modal.style.display = 'block';
      modalImg.src = imageSrc;
    }

    function closeModal() {
      document.getElementById('imageModal').style.display = 'none';
    }

    function refreshImages() {
      currentPageNum = 1;
      loadImages();
    }

    function formatDateTime(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN');
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
  </script>
</body>

</html>