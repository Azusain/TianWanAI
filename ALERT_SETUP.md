# 告警系统集成使用指南

## 🎯 概述

已成功集成告警推送功能到 cam-stream 系统中。当AI模型检测到目标时，系统会自动发送JSON格式的告警信息到指定的平台URL。

## 🔧 功能特点

- ✅ **自动告警推送**: 检测到目标时自动发送告警
- ✅ **标准API格式**: 按照 `api.md` 规范发送JSON数据
- ✅ **可配置URL**: 每个摄像头可设置独立的告警平台URL
- ✅ **KKS编码支持**: 支持摄像头KKS编码标识
- ✅ **Mock服务器**: 提供测试用的告警接收服务器

## 🚀 快速开始

### 1. 启动告警接收服务器（用于测试）

```bash
cd alert-server
go run main.go
```

服务器会在端口 8080 启动，访问 `http://localhost:8080` 查看管理界面。

### 2. 启动 cam-stream 服务器

```bash
cd cam-stream
go run *.go
```

服务器会在端口 3000 启动，访问 `http://localhost:3000` 进入管理界面。

### 3. 配置摄像头告警

1. 在浏览器中访问 `http://localhost:3000/cameras`
2. 添加或编辑摄像头时，填写以下字段：
   - **告警平台URL**: `http://localhost:8080/alert`
   - **摄像头KKS编码**: 例如 `CAM-001` 或 `1M2DTW345TV`

### 4. 测试告警功能

当系统检测到目标时，会自动发送告警到配置的URL。

你也可以手动测试告警服务器：

```bash
cd alert-server
go run test_alert.go
```

## 📋 告警数据格式

发送的JSON格式符合 `api.md` 规范：

```json
{
  "image": "base64编码的图片",
  "request_id": "唯一请求ID",
  "model": "模型类型",
  "camera_kks": "摄像头标识",
  "score": 0.95,
  "x1": 0.1,
  "y1": 0.2,
  "x2": 0.4,
  "y2": 0.6,
  "timestamp": "2024-01-01T12:00:00+08:00"
}
```

## 📁 告警存储

Mock服务器会将接收到的告警保存为JSON文件：
- **存储位置**: `alert-server/received_alerts/`
- **文件命名**: `时间戳_摄像头KKS_模型类型_请求ID.json`
- **示例**: `20240103_143052_000_CAM-001_yolo_a1b2c3d4.json`

## 🔍 监控告警

### Web界面
- 告警服务器状态: `http://localhost:8080`
- 服务器统计: `http://localhost:8080/status`
- 告警列表: `http://localhost:8080/alerts`

### 图片查看器问题解决

如果图片查看器看不到新的文件夹（如Gesture），请尝试：

1. **强制刷新浏览器**: `Ctrl + F5` (Windows) 或 `Cmd + Shift + R` (Mac)
2. **清除缓存**: 在开发者工具中清除网站缓存
3. **检查控制台**: 按 `F12` 查看是否有JavaScript错误

## ⚙️ 配置说明

### 端口配置
- **cam-stream服务器**: 端口 3000
- **告警Mock服务器**: 端口 8080
- **两个服务器运行在不同端口，不会冲突**

### 告警触发条件
- 只有当检测结果 `result.ShouldSave` 为 `true` 时才发送告警
- 这意味着检测置信度必须达到设定的阈值
- 每个检测到的目标都会发送一个单独的告警

## 🔧 故障排除

### 图片查看器问题
如果看不到新的推理服务器文件夹：
1. 检查 cam-stream 服务器是否正在运行
2. 刷新浏览器缓存 (`Ctrl + F5`)
3. 检查浏览器控制台错误信息

### 告警不发送
如果告警没有发送：
1. 确认摄像头配置中设置了 `platform_url`
2. 检查告警服务器是否在运行
3. 查看 cam-stream 服务器日志

### 网络问题
如果遇到网络连接问题：
1. 确认防火墙设置
2. 检查端口是否被占用
3. 验证URL格式是否正确

## 🎉 完成！

系统现在会自动在检测到目标时发送告警。查看 `alert-server/received_alerts/` 目录确认告警是否成功保存。
